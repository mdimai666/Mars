@using Mars.Datasource.Core.Dto
@using Mars.Datasource.Core.Nodes
@using Mars.Datasource.Front.Services
@using Mars.Nodes.Core
@using Mars.Nodes.Core.Attributes
@using Mars.Shared.Interfaces
@using Mars.WebApiClient.Interfaces
@using BlazorMonaco.Editor
@using MarsCodeEditor2
@using Microsoft.FluentUI.AspNetCore.Components
@using Microsoft.JSInterop
@using Mars.Nodes.FormEditor

@inherits NodeEditForm
@attribute [NodeEditFormForNode(typeof(SqlNode))]

<div class="form-group d-flex flex-column flex-fill">
    <div class="row mt-3">
        <div class="col">
            <label>datasource</label>
            <div class="dropdown">
                <a class="btn btn-light btn-sm rounded-0 dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                    <i class="bi bi-database-check"></i>
                    @Node.DatasourceSlug
                </a>
                <ul class="dropdown-menu rounded-0 shadow fz14px">
                    @foreach (var _a in listDatasources)
                    {
                        var a = _a;
                        if (a.Slug == Node.DatasourceSlug) continue;
                        <li><a class="dropdown-item" @onclick=@(e => Node.DatasourceSlug = a.Slug)>@a.Title</a></li>
                    }
                    @if (listDatasources.Count > 1)
                    {
                        <li><hr class="dropdown-divider"></li>
                    }
                    <li><a class="dropdown-item" href="datasource/config"><i class="bi bi-gear"></i> Настроить</a></li>
                </ul>
            </div>
        </div>
        <div class="col">
            <label>input source</label>
            <Microsoft.AspNetCore.Components.Forms.InputSelect @bind-Value=@Node.Source class="form-select form-select-sm">
                @foreach (var m in Enum.GetValues<SqlNode.ESqlNodeInputSource>())
                {
                    <option value="@m">@m</option>
                }
            </Microsoft.AspNetCore.Components.Forms.InputSelect>
        </div>
    </div>

    @if (Node.Source == SqlNode.ESqlNodeInputSource.Static)
    {
        <div class="d-flex mt-3" style="height:50vh">
            <CodeEditor2 @ref=_editor
                         Lang=@CodeEditor2.Language.sql
                         Value=@Node.SqlQuery>
                <HeaderArea>
                    <div class="d-flex flew-wrap gap-3">
                        <FluentButton OnClick="@(e => _aiTool.Open(scenarioName: "MarsSQLQueryPromptHelper"))">
                            <i class="bi bi-stars"></i>
                            AI help
                        </FluentButton>
                    </div>
                </HeaderArea>
            </CodeEditor2>

        </div>
    }

    <div class="mt-3">
        <label>output type</label>
        <Microsoft.AspNetCore.Components.Forms.InputSelect @bind-Value=@Node.OutputType class="form-select">
            @foreach (var m in Enum.GetValues<SqlNode.ESqlNodeOutputType>())
            {
                <option value="@m">@m</option>
            }
        </Microsoft.AspNetCore.Components.Forms.InputSelect>
    </div>

</div>

@code {
    [CascadingParameter] Node? Value { get; set; }
    SqlNode Node { get => (SqlNode)Value!; set => Value = value; }

    [Inject] IDatasourceServiceClient service { get; set; } = default!;
    [Inject] IAIToolAppService _aiTool { get; set; } = default!;

    CodeEditor2? _editor = default!;

    IReadOnlyCollection<SelectDatasourceDto> listDatasources = new List<SelectDatasourceDto>();

    protected override void OnInitialized()
    {
        base.OnInitialized();

        _ = Task.Run(async () =>
        {
            listDatasources = await service.ListSelectDatasource();
            StateHasChanged();
        });
    }

    public override async Task OnEditSave()
    {
        if (Node.Source == SqlNode.ESqlNodeInputSource.Static)
        {
            Node.SqlQuery = await _editor!.GetValue();
        }
    }

    void OnEditorSave(string val)
    {
        //_ = form.OnFinish();
    }

}
